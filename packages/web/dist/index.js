class e{constructor(e,t,n){this.appid=e,this.endpoint=t,this.method=n,this.plugins=[]}initSender(){console.error("需要重写 InitSender 方法")}}function t(e){return!(e>=400&&e<600)}const n="__Web_Monitor_List__";class i{constructor(e,t){this.method="post",this.endpoint=e,this.instance=t}post(e){window.navigator.sendBeacon(this.endpoint,JSON.stringify(e))}}class r{constructor(e,t,n,i=1){this.endpoint=e,this.instance=t,this.method=n,this.threshold=i,this.origin_threshold=i,this.cache=[]}_post(){const e=this,i=this.cache;return new Promise(((r,s)=>{const o=new XMLHttpRequest;o.open(e.method,e.endpoint),o.setRequestHeader("Content-Type","application/json"),o.send(JSON.stringify(i)),o.addEventListener("readystatechange",(function(){4==this.readyState&&(t(this.status)?(e.threshold!==e.origin_threshold&&(e.threshold/=2),e.cache=[],localStorage.removeItem(n)):(e.threshold*=2,localStorage.setItem(n,JSON.stringify(e.cache))),r(this.response))}))}))}post(e){return this.cache.push(e),this.cache.length<this.threshold?(localStorage.setItem(n,JSON.stringify(this.cache)),Promise.resolve("cache success")):this._post()}}var s;!function(e){e[e.Image=0]="Image",e[e.CSS=1]="CSS",e[e.Font=2]="Font",e[e.Javascript=3]="Javascript",e[e.Video=4]="Video",e[e.Audio=5]="Audio"}(s||(s={}));class o{constructor(e,t){this.category="stability",this.type="JS",this.stack=t,this.message=e}}class a{constructor(e,t){this.category="stability",this.type="HTTP",this.code=e,this.url=t}}class c{constructor(e,t){this.category="stability",this.type="Resource",this.resourceType=e,this.src=t}}class u{constructor(e,t,n,i){this.category="performance",this.type="LongTimeTask",this.startTime=e,this.duration=t,this.eventType=n,this.eventName=i}}class h{constructor(e){this.category="performance",this.type="WebVitals",this.webvitals=e}}function d(e){const t=navigator.userAgent,n=new Date,i=e.fingerprint;return{path:window.location.href,userAgent:t,dateTime:n,fingerPrint:i}}function l(e,t,n){const i=d(e),r=new o(t,n);return Object.assign(Object.assign({},i),r)}function f(e,t,n){const i=d(e);let r=t.status,s="";if("XHR"==n){s=t.responseURL}else{s=t.url}return Object.assign(Object.assign({},i),new a(r,s))}class p{constructor(e){this.instance=e,this.hasError=!1,this.events=[];const t=e.senderInstance;this.error_listener=n=>{const i=l(e,n.message,n.error.stack);null==t||t.post(i),this.hasError=!0},this.promise_listener=n=>{var i;if(void 0!==n.target.localname)return;const r=l(e,n.message,null===(i=n.error)||void 0===i?void 0:i.stack);null==t||t.post(r),this.hasError=!0}}init(){}run(){console.log("开始监听"),window.addEventListener("error",this.error_listener),window.addEventListener("unhandledrejection",this.promise_listener)}unload(){window.removeEventListener("error",this.error_listener),window.removeEventListener("unhandledrejection",this.promise_listener)}}class v{constructor(e){this.instance=e,this.duringHijack=!1}init(){}run(){const e=this;this.nativeXHRSend=XMLHttpRequest.prototype.send,XMLHttpRequest.prototype.send=function(...n){let i=this;i.addEventListener("abort",(function(){})),i.addEventListener("readystatechange",(function(){var n;if(4==this.readyState&&!t(this.status)){const t=f(e.instance,this,"XHR");null===(n=e.instance.senderInstance)||void 0===n||n.post(t)}})),e.nativeXHRSend.apply(i,n)},window.fetch&&(this.nativeFetch=fetch,window.fetch=function(...t){const n=e.nativeFetch(...t);return n.then((t=>{var n;if(t.ok){const i=f(e.instance,t,"Fetch");null===(n=e.instance.senderInstance)||void 0===n||n.post(i)}}),(e=>{})),n})}unload(){XMLHttpRequest.prototype.send=this.nativeXHRSend,window.fetch=this.nativeFetch}}const m={link:s.CSS,script:s.Javascript,img:s.Image,video:s.Video,audio:s.Audio};class g{constructor(e){this.listener=null,this.instance=e}init(){}run(){const e=this,t=function(t){var n;const i=t.target.localName,r=t.target.src;let s=function(e,t,n){const i=d(e);return Object.assign(Object.assign({},i),new c(t,n))}(e.instance,m[i],r);null===(n=e.instance.senderInstance)||void 0===n||n.post(s)};this.listener=t,window.addEventListener("error",t,!0)}unload(){this.listener&&window.removeEventListener("error",this.listener)}}class w{constructor(e){this.instance=e}init(){}run(){this.observer=new PerformanceObserver((e=>{e.getEntries().forEach((e=>{var t;if(e.duration<100)return;const n=function(e,t){const n=d(e);return Object.assign(Object.assign({},n),new u(t.startTime,t.duration,t.name,t.entryType))}(this.instance,e);null===(t=this.instance.senderInstance)||void 0===t||t.post(n)}))})),this.observer.observe({entryTypes:["longtask"]})}unload(){var e;null===(e=this.observer)||void 0===e||e.disconnect()}}function y(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{c(i.next(e))}catch(e){s(e)}}function a(e){try{c(i.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((i=i.apply(e,t||[])).next())}))}var E,b,S,L,T=-1,C=function(e){addEventListener("pageshow",(function(t){t.persisted&&(T=t.timeStamp,e(t))}),!0)},P=function(){return window.performance&&performance.getEntriesByType&&performance.getEntriesByType("navigation")[0]},I=function(){var e=P();return e&&e.activationStart||0},O=function(e,t){var n=P(),i="navigate";return T>=0?i="back-forward-cache":n&&(i=document.prerendering||I()>0?"prerender":document.wasDiscarded?"restore":n.type.replace(/_/g,"-")),{name:e,value:void 0===t?-1:t,rating:"good",delta:0,entries:[],id:"v3-".concat(Date.now(),"-").concat(Math.floor(8999999999999*Math.random())+1e12),navigationType:i}},A=function(e,t,n){try{if(PerformanceObserver.supportedEntryTypes.includes(e)){var i=new PerformanceObserver((function(e){Promise.resolve().then((function(){t(e.getEntries())}))}));return i.observe(Object.assign({type:e,buffered:!0},n||{})),i}}catch(e){}},F=function(e,t){var n=function n(i){"pagehide"!==i.type&&"hidden"!==document.visibilityState||(e(i),t&&(removeEventListener("visibilitychange",n,!0),removeEventListener("pagehide",n,!0)))};addEventListener("visibilitychange",n,!0),addEventListener("pagehide",n,!0)},_=function(e,t,n,i){var r,s;return function(o){t.value>=0&&(o||i)&&((s=t.value-(r||0))||void 0===r)&&(r=t.value,t.delta=s,t.rating=function(e,t){return e>t[1]?"poor":e>t[0]?"needs-improvement":"good"}(t.value,n),e(t))}},k=function(e){requestAnimationFrame((function(){return requestAnimationFrame((function(){return e()}))}))},H=function(e){document.prerendering?addEventListener("prerenderingchange",(function(){return e()}),!0):e()},R=-1,j=function(){return"hidden"!==document.visibilityState||document.prerendering?1/0:0},x=function(e){"hidden"===document.visibilityState&&R>-1&&(R="visibilitychange"===e.type?e.timeStamp:0,B())},M=function(){addEventListener("visibilitychange",x,!0),addEventListener("prerenderingchange",x,!0)},B=function(){removeEventListener("visibilitychange",x,!0),removeEventListener("prerenderingchange",x,!0)},D=function(){return R<0&&(R=j(),M(),C((function(){setTimeout((function(){R=j(),M()}),0)}))),{get firstHiddenTime(){return R}}},X=function(e,t){t=t||{},H((function(){var n,i=[1800,3e3],r=D(),s=O("FCP"),o=A("paint",(function(e){e.forEach((function(e){"first-contentful-paint"===e.name&&(o.disconnect(),e.startTime<r.firstHiddenTime&&(s.value=Math.max(e.startTime-I(),0),s.entries.push(e),n(!0)))}))}));o&&(n=_(e,s,i,t.reportAllChanges),C((function(r){s=O("FCP"),n=_(e,s,i,t.reportAllChanges),k((function(){s.value=performance.now()-r.timeStamp,n(!0)}))})))}))},J=function(e,t){t=t||{},H((function(){var n,i=[.1,.25],r=O("CLS"),s=-1,o=0,a=[],c=function(t){s>-1&&e(t)},u=function(e){e.forEach((function(e){if(!e.hadRecentInput){var t=a[0],i=a[a.length-1];o&&e.startTime-i.startTime<1e3&&e.startTime-t.startTime<5e3?(o+=e.value,a.push(e)):(o=e.value,a=[e]),o>r.value&&(r.value=o,r.entries=a,n())}}))},h=A("layout-shift",u);h&&(n=_(c,r,i,t.reportAllChanges),X((function(e){s=e.value,r.value<0&&(r.value=0,n())})),F((function(){u(h.takeRecords()),n(!0)})),C((function(){o=0,s=-1,r=O("CLS",0),n=_(c,r,i,t.reportAllChanges),k((function(){return n()}))})))}))},q={passive:!0,capture:!0},N=new Date,V=function(e,t){E||(E=t,b=e,S=new Date,z(removeEventListener),W())},W=function(){if(b>=0&&b<S-N){var e={entryType:"first-input",name:E.type,target:E.target,cancelable:E.cancelable,startTime:E.timeStamp,processingStart:E.timeStamp+b};L.forEach((function(t){t(e)})),L=[]}},U=function(e){if(e.cancelable){var t=(e.timeStamp>1e12?new Date:performance.now())-e.timeStamp;"pointerdown"==e.type?function(e,t){var n=function(){V(e,t),r()},i=function(){r()},r=function(){removeEventListener("pointerup",n,q),removeEventListener("pointercancel",i,q)};addEventListener("pointerup",n,q),addEventListener("pointercancel",i,q)}(t,e):V(t,e)}},z=function(e){["mousedown","keydown","touchstart","pointerdown"].forEach((function(t){return e(t,U,q)}))},G=function(e,t){t=t||{},H((function(){var n,i=[100,300],r=D(),s=O("FID"),o=function(e){e.startTime<r.firstHiddenTime&&(s.value=e.processingStart-e.startTime,s.entries.push(e),n(!0))},a=function(e){e.forEach(o)},c=A("first-input",a);n=_(e,s,i,t.reportAllChanges),c&&F((function(){a(c.takeRecords()),c.disconnect()}),!0),c&&C((function(){var r;s=O("FID"),n=_(e,s,i,t.reportAllChanges),L=[],b=-1,E=null,z(addEventListener),r=o,L.push(r),W()}))}))},K={},Q=function(e,t){t=t||{},H((function(){var n,i=[2500,4e3],r=D(),s=O("LCP"),o=function(e){var t=e[e.length-1];if(t){var i=Math.max(t.startTime-I(),0);i<r.firstHiddenTime&&(s.value=i,s.entries=[t],n())}},a=A("largest-contentful-paint",o);if(a){n=_(e,s,i,t.reportAllChanges);var c=function(){K[s.id]||(o(a.takeRecords()),a.disconnect(),K[s.id]=!0,n(!0))};["keydown","click"].forEach((function(e){addEventListener(e,c,{once:!0,capture:!0})})),F(c,!0),C((function(r){s=O("LCP"),n=_(e,s,i,t.reportAllChanges),k((function(){s.value=performance.now()-r.timeStamp,K[s.id]=!0,n(!0)}))}))}}))},Y=function e(t){document.prerendering?H((function(){return e(t)})):"complete"!==document.readyState?addEventListener("load",(function(){return e(t)}),!0):setTimeout(t,0)},Z=function(e,t){t=t||{};var n=[800,1800],i=O("TTFB"),r=_(e,i,n,t.reportAllChanges);Y((function(){var s=P();if(s){var o=s.responseStart;if(o<=0||o>performance.now())return;i.value=Math.max(o-I(),0),i.entries=[s],r(!0),C((function(){i=O("TTFB",0),(r=_(e,i,n,t.reportAllChanges))(!0)}))}}))};class ${constructor(e){this.instance=e,this.performance={}}init(){}collectValue(e,t){return Promise.all(e.map(((e,n)=>new Promise(((i,r)=>{e((e=>{const r=t[n];this.performance[r]=e,i(e)}))})))))}run(){var e;return y(this,void 0,void 0,(function*(){yield this.collectValue([J,G,Q,X,Z],["CLS","FID","LCP","FCP","TTFB"]),null===(e=this.instance.senderInstance)||void 0===e||e.post(function(e,t){const n=d(e);return Object.assign(Object.assign({},n),new h(t))}(this.instance,this.performance))}))}unload(){}}class ee extends e{constructor(e,t,n,i="xhr",r=1){super(e,t,n),this.fingerprint="unknown",this.plugins=[],this.initSender(i,n,t,r),this.initPlugins()}initSender(e,t,n,s){var o;let a=e;"get"==t&&"beacon"==e?(console.error("Beacon上报不支持 get 方法, 将用 xhr 继续上传"),a="xhr"):"beacon"==e&&"function"!=typeof(null===(o=null===window||void 0===window?void 0:window.navigator)||void 0===o?void 0:o.sendBeacon)&&(console.error("浏览器不兼容Beacon，将用 xhr 继续上传"),a="xhr"),this.senderInstance="beacon"==a?new i(n,this):new r(n,this,t,s)}initPlugins(){const e=[new p(this),new v(this),new g(this),new w(this),new $(this)];this.plugins=e}start(){this.plugins.forEach((e=>{e.run()}))}}export{ee as default};
