class t{constructor(t,e,s){this.appid=t,this.endpoint=e,this.method=s,this.plugins=[]}initSender(){console.error("需要重写 InitSender 方法")}}function e(t){return!(t>=400&&t<600)}const s="__Web_Monitor_List__";class n{constructor(t,e){this.method="post",this.endpoint=t,this.instance=e}post(t){window.navigator.sendBeacon(this.endpoint,JSON.stringify(t))}}class i{constructor(t,e,s,n=1){this.endpoint=t,this.instance=e,this.method=s,this.threshold=n,this.origin_threshold=n,this.cache=[]}_post(){const t=this,n=this.cache;return new Promise(((i,r)=>{const o=new XMLHttpRequest;o.open(t.method,t.endpoint),o.setRequestHeader("Content-Type","application/json"),o.send(JSON.stringify(n)),o.addEventListener("readystatechange",(function(){4==this.readyState&&(e(this.status)?(t.threshold!==t.origin_threshold&&(t.threshold/=2),t.cache=[],localStorage.removeItem(s)):(t.threshold*=2,localStorage.setItem(s,JSON.stringify(t.cache))),i(this.response))}))}))}post(t){return this.cache.push(t),this.cache.length<this.threshold?(localStorage.setItem(s,JSON.stringify(this.cache)),Promise.resolve("cache success")):this._post()}}var r;!function(t){t[t.Image=0]="Image",t[t.CSS=1]="CSS",t[t.Font=2]="Font",t[t.Javascript=3]="Javascript",t[t.Video=4]="Video",t[t.Audio=5]="Audio"}(r||(r={}));class o{constructor(t,e){this.category="stability",this.type="JS",this.stack=e,this.message=t}}class c{constructor(t,e){this.category="stability",this.type="HTTP",this.code=t,this.url=e}}class a{constructor(t,e){this.category="stability",this.type="Resource",this.resourceType=t,this.src=e}}class h{constructor(t,e,s,n){this.category="performance",this.type="LongTimeTask",this.startTime=t,this.duration=e,this.eventType=s,this.eventName=n}}function d(t){const e=navigator.userAgent,s=new Date,n=t.fingerprint;return{path:window.location.href,userAgent:e,dateTime:s,fingerPrint:n}}function l(t,e,s){const n=d(t),i=new o(e,s);return Object.assign(Object.assign({},n),i)}function u(t,e,s){const n=d(t);let i=e.status,r="";if("XHR"==s){r=e.responseURL}else{r=e.url}return Object.assign(Object.assign({},n),new c(i,r))}class p{constructor(t){this.instance=t,this.hasError=!1,this.events=[];const e=t.senderInstance;this.error_listener=s=>{const n=l(t,s.message,s.error.stack);null==e||e.post(n),this.hasError=!0},this.promise_listener=s=>{var n;if(void 0!==s.target.localname)return;const i=l(t,s.message,null===(n=s.error)||void 0===n?void 0:n.stack);null==e||e.post(i),this.hasError=!0}}init(){}run(){console.log("开始监听"),window.addEventListener("error",this.error_listener),window.addEventListener("unhandledrejection",this.promise_listener)}unload(){window.removeEventListener("error",this.error_listener),window.removeEventListener("unhandledrejection",this.promise_listener)}}class g{constructor(t){this.instance=t,this.duringHijack=!1}init(){}run(){const t=this;this.nativeXHRSend=XMLHttpRequest.prototype.send,XMLHttpRequest.prototype.send=function(...s){let n=this;n.addEventListener("abort",(function(){})),n.addEventListener("readystatechange",(function(){var s;if(4==this.readyState&&!e(this.status)){const e=u(t.instance,this,"XHR");null===(s=t.instance.senderInstance)||void 0===s||s.post(e)}})),t.nativeXHRSend.apply(n,s)},window.fetch&&(this.nativeFetch=fetch,window.fetch=function(...e){const s=t.nativeFetch(...e);return s.then((e=>{var s;if(e.ok){const n=u(t.instance,e,"Fetch");null===(s=t.instance.senderInstance)||void 0===s||s.post(n)}}),(t=>{})),s})}unload(){XMLHttpRequest.prototype.send=this.nativeXHRSend,window.fetch=this.nativeFetch}}const v={link:r.CSS,script:r.Javascript,img:r.Image,video:r.Video,audio:r.Audio};class w{constructor(t){this.listener=null,this.instance=t}init(){}run(){const t=this,e=function(e){var s;const n=e.target.localName,i=e.target.src;let r=function(t,e,s){const n=d(t);return Object.assign(Object.assign({},n),new a(e,s))}(t.instance,v[n],i);null===(s=t.instance.senderInstance)||void 0===s||s.post(r)};this.listener=e,window.addEventListener("error",e,!0)}unload(){this.listener&&window.removeEventListener("error",this.listener)}}class f{constructor(t){this.instance=t}init(){}run(){this.observer=new PerformanceObserver((t=>{t.getEntries().forEach((t=>{var e;if(t.duration<100)return;const s=function(t,e){const s=d(t);return Object.assign(Object.assign({},s),new h(e.startTime,e.duration,e.name,e.entryType))}(this.instance,t);null===(e=this.instance.senderInstance)||void 0===e||e.post(s)}))})),this.observer.observe({entryTypes:["longtask"]})}unload(){var t;null===(t=this.observer)||void 0===t||t.disconnect()}}class m extends t{constructor(t,e,s,n="xhr",i=1){super(t,e,s),this.fingerprint="unknown",this.plugins=[],this.initSender(n,s,e,i),this.initPlugins()}initSender(t,e,s,r){var o;let c=t;"get"==e&&"beacon"==t?(console.error("Beacon上报不支持 get 方法, 将用 xhr 继续上传"),c="xhr"):"beacon"==t&&"function"!=typeof(null===(o=null===window||void 0===window?void 0:window.navigator)||void 0===o?void 0:o.sendBeacon)&&(console.error("浏览器不兼容Beacon，将用 xhr 继续上传"),c="xhr"),this.senderInstance="beacon"==c?new n(s,this):new i(s,this,e,r)}initPlugins(){const t=[new p(this),new g(this),new w(this),new f(this)];this.plugins=t}start(){this.plugins.forEach((t=>{t.run()}))}}export{m as default};
